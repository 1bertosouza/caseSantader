---
# Playbook: PostgreSQL Day-2 operations
# Provides tasks for backup, restore, status checks, start/stop, and user creation.
# Usage examples:
#  ansible-playbook -i ansible/inventory.ini ansible/postgres_day2.yml --tags backup
#  ansible-playbook -i ansible/inventory.ini ansible/postgres_day2.yml --tags status

- name: PostgreSQL Day-2 operations
  hosts: postgres
  become: true
  vars_files:
    - vars.yml

  tasks:
    - name: Ensure backup directory exists
      file:
        path: "{{ backup_dir }}"
        state: directory
        owner: "{{ pg_superuser }}"
        mode: '0750'
      tags: [setup,backup]

    - name: Check PostgreSQL process (pg_isready)
      become_user: "{{ pg_superuser }}"
      shell: pg_isready -p {{ pg_port }}
      register: pg_ready
      changed_when: false
      failed_when: pg_ready.rc not in [0,2]
      tags: [status]

    - name: Show pg_isready output
      debug:
        var: pg_ready.stdout
      tags: [status]

    - name: Start PostgreSQL service
      service:
        name: postgresql
        state: started
      tags: [start]

    - name: Stop PostgreSQL service
      service:
        name: postgresql
        state: stopped
      tags: [stop]

    - name: Backup all databases (logical backup)
      become_user: "{{ pg_superuser }}"
      shell: |
        set -o pipefail
        timestamp=$(date -u +"%Y%m%dT%H%M%SZ")
        outfile="{{ backup_dir }}/pg_dumpall_${timestamp}.sql.gz"
        pg_dumpall -U {{ db_admin }} | gzip -c > ${outfile}
        echo ${outfile}
      args:
        executable: /bin/bash
      register: backup_out
      tags: [backup]

    - name: Report backup file
      debug:
        msg: "Backup created: {{ backup_out.stdout }}"
      when: backup_out is defined
      tags: [backup]

    - name: Purge old backups
      shell: |
        find {{ backup_dir }} -type f -name "pg_dumpall_*.sql.gz" -mtime +{{ backup_retention_days }} -delete
      args:
        warn: false
      tags: [backup]

    - name: Restore a logical backup (requires `restore_file` extra var)
      when: restore_file is defined
      become_user: "{{ pg_superuser }}"
      shell: |
        set -o pipefail
        gunzip -c "{{ restore_file }}" | psql -U {{ db_admin }}
      args:
        executable: /bin/bash
      tags: [restore]

    - name: Create database user (idempotent)
      community.postgresql.postgresql_user:
        name: "{{ new_db_user | default('app_user') }}"
        password: "{{ new_db_password | default('changeme') }}"
        login: yes
      become_user: "{{ pg_superuser }}"
      tags: [user]

    - name: Check replication lag (if pg_stat_replication exists)
      become_user: "{{ pg_superuser }}"
      shell: |
        psql -U {{ db_admin }} -Atc "SELECT client_addr, state, sync_state, COALESCE(pg_wal_lsn_diff(pg_current_wal_lsn(), replay_lsn),0) AS lag_bytes FROM pg_stat_replication;" || true
      register: repl_lag
      changed_when: false
      tags: [status]

    - name: Show replication info
      debug:
        var: repl_lag.stdout_lines
      tags: [status]
